<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">设备树 | 聆思文档中心</title><meta data-react-helmet="true" property="og:url" content="https://github.com/LISTENAI/chips/600X/application/device_tree"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="设备树 | 聆思文档中心"><meta data-react-helmet="true" name="description" content="概述"><meta data-react-helmet="true" property="og:description" content="概述"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/LISTENAI/chips/600X/application/device_tree"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/chips/600X/application/device_tree" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/chips/600X/application/device_tree" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b99cbd79.css">
<link rel="preload" href="/assets/js/runtime~main.8ca08ee5.js" as="script">
<link rel="preload" href="/assets/js/main.8a90d51c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1knm">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" titleclassname="navbar__title" href="/"><img src="/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--light_1H0o navbar__logo"><img src="/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--dark_2hTa navbar__logo"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/chips/4002/Chip_information_4002">芯片</a><a class="navbar__item navbar__link" href="/tools/LStudio">工具</a><a class="navbar__item navbar__link" href="/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a><a class="navbar__item navbar__link" href="/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/faq/faq">FAQ</a><a class="navbar__item navbar__link" href="/school/school">视频课程</a><a class="navbar__item navbar__link" href="/workorder/workorder">工单</a><div class="react-toggle displayOnlyInLargeViewport_3VZa react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_ZCuN"><img src="/img/light.svg" alt="" class="themedImage_1WWj themedImage--light_1H0o"><img src="/img/unlight.svg" alt="" class="themedImage_1WWj themedImage--dark_2hTa"></span></div><div class="react-toggle-track-x"><span class="toggle_ZCuN"><img src="/img/undark.svg" alt="" class="themedImage_1WWj themedImage--light_1H0o"><img src="/img/dark.svg" alt="" class="themedImage_1WWj themedImage--dark_2hTa"></span></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_MM2z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" titleclassname="navbar__title" href="/"><img src="/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--light_1H0o navbar__logo"><img src="/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--dark_2hTa navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link mobile__navbar__link--active" href="/chips/4002/Chip_information_4002">芯片</a></li><li class="menu__list-item"><a class="menu__link" href="/tools/LStudio">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a></li><li class="menu__list-item"><a class="menu__link" href="/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></li><li class="menu__list-item"><a class="menu__link" href="/faq/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/school/school">视频课程</a></li><li class="menu__list-item"><a class="menu__link" href="/workorder/workorder">工单</a></li></ul></div></div></div></nav><nav class="navbar subnavbar--fixed-top sub-navbar"><div class="navbar__inner subnavbar__inner"><div class="navbar__items"><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/chips/4002/Chip_information_4002">CSK4002</a><a aria-current="page" class="subnavbar__item subnavbar__link subnavbar__link--active" dirname="/chips" href="/chips/600X/overview/chips">CSK600X</a><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/chips/micropython/index">MicroPython</a></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_2GEL"><aside class="docSidebarContainer_2S6d"><div class="sidebar_3rk8"><nav class="menu menu--responsive thin-scrollbar menu_1wJ3 menuWithAnnouncementBar_39W0" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_24hZ" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">简介</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/overview/chips">芯片</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/overview/nanokit">NanoKit 开发套件</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/overview/system">系统与软件</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">快速上手</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/quick_start/start_env">安装开发工具</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/quick_start/start_project">开始新项目</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/quick_start/doc_issue">反馈</a></li></ul></li><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--first menu__link--sublist menu__link--active" type="first" href="#!">应用开发</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/structure">应用代码结构</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/kconfig">项目配置</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/chips/600X/application/device_tree">设备树</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="0">外设驱动</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/overview">外设驱动的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/gpio">GPIO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/pwm">PWM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/UART">UART</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/I2C">I2C</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/ADC">ADC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/RTC">RTC</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="0">组件</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/logger">日志</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/usb_class">USB 模块</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/display">显示/触摸</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/lvgl">LVGL</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/sdk_command">SDK 操作</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/env_command">编译环境</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/create_command">创建项目</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/application_project">应用级提货单</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/app_build_flash">编译，烧录</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/debug_command">调试</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/filesystem">文件系统相关</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/trouble_shooting">疑难解答</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/release_note">版本更新日志</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/chips/600X/FAQ/index">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_3dT7"><div class="container padding-top--md padding-bottom--lg center-container"><div class="row"><div class="col docItemCol_3Jy6"><div class="docItemContainer_1Utn"><article><div class="markdown"><header><h1 class="h1Heading_2YTE">设备树</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="概述"></a>概述<a class="hash-link" href="#概述" title="Direct link to heading">#</a></h2><p>DeviceTree作为一种用来描述板载硬件资源的层级数据结构,由两种元素组成：Node(节点)、Property(属性)。Zephyr使用他来表示支持板子上的可用资源，当然，还包括一些硬件的初始化配置信息。</p><p>Linux 内核从 3.x 版本之后开始支持使用设备树，而Zephyr从设计之初就引入了设备树。在此之前，与硬件设备相关的具体信息需要写在驱动代码中，如果外设发生相应的变化，那么驱动代码就需要改动。</p><p>zephyr类似于Linux通过设备树来管理硬件，与Linux不同的是，zephyr不直接使用DTB(设备树编译后的二进制文件)，因为运行zephyrOS的硬件大部分是资源受限的嵌入式系统，很多MCU的资源都不够支撑运行一个DTB框架，所以zephyr工程直接将设备树通过脚本处理成c语言头文件，给应用程序调用的设备树API都是一些宏定义或宏函数。</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Zephyr官网针对设备树进行了详细的说明，如果您喜欢查阅Zephyr官网文档，可以到<a href="https://docs.zephyrproject.org/latest/build/dts/index.html?highlight=devicetree" target="_blank" rel="noopener noreferrer">Devicetree</a>查看设备树相关说明，如果您觉得Zephyr官网文档不好理解，不妨看看本章节对设备树的描述。</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树编译流程"></a>设备树编译流程<a class="hash-link" href="#设备树编译流程" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树编译整体流程描述"></a>设备树编译整体流程描述<a class="hash-link" href="#设备树编译整体流程描述" title="Direct link to heading">#</a></h3><p>zephyr工程直接将设备树通过脚本处理成c语言头文件，设备树输入文件有两种类型:<code>.dts source</code>文件和<code>.ymal binding</code>文件。<code>source</code>文件包含了设备树的配置信息，<code>binding</code>文件描述设备树的规则包括据数据类型等。构建系统使用devicetree源文件和binding来生成生成的C头文件<code>devicetree.h</code>，所有包括设备驱动程序、应用程序、测试、内核等开发都可以通过include<code>devicetree.h</code>来使用设备树。
以下是该过程的简化视图:
<img src="/assets/images/devicedree_build-e7cf31bcb98797ce3007ed7c67ad0ff1.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树编译的输入输出文件"></a>设备树编译的输入输出文件<a class="hash-link" href="#设备树编译的输入输出文件" title="Direct link to heading">#</a></h3><p><img src="/assets/images/zephyr_dt_inputs_outputs-8a4a539b340ea98d792374c35f3ba97a.png">
整个流程有4种输入文件:</p><ul><li>sources (.dts) : 一般是board的dts文件</li><li>includes (.dtsi)：被dts包含的dtsi文件，是soc或者驱动级的公用描述</li><li>overlays (.overlay)：对于相同的应用采用不同的板子时，可以在应用下放不同overlay文件配置应用要用的设备</li><li>bindings (.yaml)： binding文件，用于帮助dts生成宏</li></ul><p>以上文件通常会出现在下面路径：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">CSK6 SDK\boards\arm\csk6002_9s_nano\csk6002_9s_nano.dts</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CSK6 SDK\boards\arm\csk6002_9s_nano\csk6002_9s_nano_pinctrl.dtsi</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">app\xxx.overlay</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CSK6 SDK\dts\bindings\xxx\xxx.yaml</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>3种输出文件：</p><ul><li>zephyr.dts.pre：这是一个中间输出文件</li><li>zephyr.dts：该文件是dts、dtsi、overlay合并为一个文件，zephyr.dts只是方便调试查看，不会对之后的构建有任何帮助</li><li>devicetree.h：dts最后生成的宏，会被代码引用</li></ul><p>以上文件通常会出现在下面路径：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">app\build\zephyr\zephyr.dts</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CSK6 SDK\include\devicetree.h</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">app\build\zephyr\include\generated\devicetree_fixups.h</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">app\build\zephyr\include\generated\devicetree_unfixed.h</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="使用设备树需要了解的文件"></a>使用设备树需要了解的文件<a class="hash-link" href="#使用设备树需要了解的文件" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="dts文件"></a>dts文件<a class="hash-link" href="#dts文件" title="Direct link to heading">#</a></h4><ul><li><p><strong>dts</strong>：设备树的源文件，用来定义硬件设备的细节，比如定义一个 <em>uart</em> 设备，并定义其引脚信息等；</p></li><li><p><strong>dtsi</strong>：设备树的头文件，<em>.dts</em> 可以像<em>C语言</em>一样，通过 <em>#include</em> 来包含它；</p></li></ul><blockquote><ul><li><em>.dtsi</em> 文件我们用于定义 SoC 的设备，如：CPU架构、主频、各外设寄存器地址范围等；</li><li>.dts* 文件是基于某个 soc 的开发板设备定义，比如配置外设的使能、引脚，flash的分区等；</li></ul></blockquote><p>dtsi是设备树头文件，类似c语言的.h文件，一般用于描述一个硬件模块，供板级dts或soc级dtsi引用。所以可以把一个固定硬件的设备信息放到.dtsi文件中。比如一个soc，一个型号的soc他的硬件资源是不会变的，所以可以统一写在一个dtsi中供板级dts文件引用。soc模块会包括cpu IP核和uart ip等，那么可以把一个cpu的的硬件资源或者uart资源可以写在dtsi文件中，供soc的dtsi引用。一般情况下，一个板级文件可以定义在多个dts文件中，在设备树编译阶段，会由脚本合并多个dts文件。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="binding文件"></a>binding文件<a class="hash-link" href="#binding文件" title="Direct link to heading">#</a></h4><p>bindings文件在zephyr工程中是以.yaml文件形式存在，bindings顾名思义，绑定或者胶水的意思，他作为c语言和设备树之前的桥梁存在。bingdings可以解释设备树中设备节点的属性代表什么意思。前面提到的将设备树转换为c语言头文件，就是根据bindings文件中定义的规则来转换的。
例如<code>CSK6 SDK\boards\arm\csk6002_9s_nano\csk6002_9s_nano.dts</code>中<code>pwmleds</code>的配置如下：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pwmleds </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pwm-leds&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        green_pwm_led</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> green_pwm_led </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            pwms </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">pwm0 </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> PWM_POLARITY_NORMAL</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;User BOARD_LED_2 - PWM0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>对应的bindings文件<code>CSK6 SDK\dts\bindings\led\pwm-leds.yaml</code></p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">description</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> PWM LEDs parent node</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">compatible</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pwm-leds&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">include</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> name</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> base</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">yaml</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      property</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">allowlist</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">label</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">properties</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    label</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      description</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        Human readable string describing the device and used to set the device</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> It can be passed as argument to </span><span class="token function" style="color:rgb(220, 220, 170)">device_get_binding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> to retrieve</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        the device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> If this property is omitted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> then the device name is set</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        from the node full name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">child</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">binding</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    description</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> PWM LED child node</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    properties</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        pwms</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          required</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> true</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> phandle</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">array</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        label</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          required</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> false</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          type</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          description</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            Human readable string describing the LED</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> It can be used by an</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            application to identify this LED or to retrieve its number</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token function" style="color:rgb(220, 220, 170)">index</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> child node number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> on the parent device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>构建系统会根据dts文件中<code>compatible</code> 匹配对应的bindings文件。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树头文件devicetreeh"></a>设备树头文件devicetree.h<a class="hash-link" href="#设备树头文件devicetreeh" title="Direct link to heading">#</a></h4><p>在zephyr中使用设备树，只要include devicetree.h头文件就可以了。这里面主要定义了设备树供c语言调用的API。
<code>devicetree.h</code>路径 <code>CSK6 SDK/include/devicetree.h</code></p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&lt;devicetree_unfixed.h&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&lt;devicetree_fixups.h&gt;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>可以看到<code>devicetree.h</code> 中包含了 <code>devicetree_unfixed.h</code>，<code>devicetree_fixups.h</code>，这两个个文件是在编译时产生的。其中
<code>devicetree_unfixed.h </code>：根据工程中的设备树生成，把设备树的节点信息转换为宏定义等，供设备树API使用。
<code>devicetree_fixups.h </code>：<code>devicetree_legacy_unfixed.h</code>的别名。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树的定义"></a>设备树的定义<a class="hash-link" href="#设备树的定义" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树文件结构"></a>设备树文件结构<a class="hash-link" href="#设备树文件结构" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="sdk-内部"></a>SDK 内部<a class="hash-link" href="#sdk-内部" title="Direct link to heading">#</a></h4><p>非 SDK 开发者一般是不需要关心内部的设备树设计的，但如果你想了解 CSK6 SoC 的设备定义，或者想要 <a href="/chips/600X/application/board">自定义Board</a>的话，你可以通过查阅这部分的 <em>dts</em> 文件来深入了解。</p><blockquote><p>以下文件是以 sdk 为根目录</p></blockquote><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">zephyr</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> ├── dts/&lt;ARCH&gt;/&lt;SoC&gt;/*.dtsi</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> └── board/&lt;ARCH&gt;/&lt;BOARD&gt;/*.dts</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="项目级别"></a>项目级别<a class="hash-link" href="#项目级别" title="Direct link to heading">#</a></h4><p>除了 SDK 支持的芯片、板型以外，开发者也可以在项目中，自定义 <em>dts</em> 来增加，或者修改 Board 的定义。</p><blockquote><p>以下文件是以应用目录为根目录</p></blockquote><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">app</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> ├── dts/&lt;ARCH&gt;/&lt;Board&gt;/*.dts</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> └── board/&lt;BOARD&gt;.overlay</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="dts-语法"></a>DTS 语法<a class="hash-link" href="#dts-语法" title="Direct link to heading">#</a></h3><p>DTS 语法与 Linux 设备树保持一致，更多信息可以参阅：<a href="https://iflyos-external.oss-cn-shanghai.aliyuncs.com/public/lsopen/zephyr/PDF/devicetree-specification-v0.1-20160524.pdf" target="_blank" rel="noopener noreferrer">Devicetree spec</a>。</p><p>下面我们主要简单讲解 <em>DTS</em> 的一些基本元素。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="devicetree"></a>DeviceTree<a class="hash-link" href="#devicetree" title="Direct link to heading">#</a></h4><p>设备树是由节点(node)组成的，有根节点和子节点。</p><p>下面是 <em>csk6</em> 的 <em>dtsi</em> 的一个示例：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    sram0</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> memory@</span><span class="token number" style="color:rgb(181, 206, 168)">80000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;mmio-sram&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        reg </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token function" style="color:rgb(220, 220, 170)">x00080000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">320</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    psram0</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> psram@</span><span class="token number" style="color:rgb(181, 206, 168)">30000000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;listenai,csk6-psram&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        reg </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">0x30000000</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">DT_SIZE_M</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;psram0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="节点---node"></a>节点 - Node<a class="hash-link" href="#节点---node" title="Direct link to heading">#</a></h4><p>在设备树中，<strong>node</strong> 由节点名、节点内容组成的。下面是一个一个典型的形式：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">node1@address </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    node2@address</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p><strong>节点名</strong></p><p>其中 <code>node1</code> 是它的节点名，<code>address</code> 是节点的第一个寄存地址，如果没有寄存器 <em>@address</em> 为空。</p><p>节点名长度应该小于 <em>31</em> 个字符，对于不同类型的设备，<a href="https://iflyos-external.oss-cn-shanghai.aliyuncs.com/public/lsopen/zephyr/PDF/devicetree-specification-v0.1-20160524.pdf" target="_blank" rel="noopener noreferrer">Devicetree spec</a> 有推荐对应的设备名，但并非强制。</p><blockquote><p>注意：根节点名为 <em>/</em> ，根节点必须有，且只有一个。</p></blockquote><p><strong>节点属性</strong></p><p>节点的属性是键值对的形式，如：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">reg </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token function" style="color:rgb(220, 220, 170)">x00080000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">320</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token number" style="color:rgb(181, 206, 168)">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>其中 <em>reg</em> 是属性名，&lt;0x00080000 (320*1024)&gt; 是属性值。</p><p><strong>属性名</strong></p><p>属性名有两种情况，一种是<strong>标准</strong>属性名，一种是<strong>非标准</strong>属性名。</p><p>对于非标准属性名，一般会添加前缀来进行区分，比如：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">csk,wifi_module</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">csk,pinctrl</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p><strong>属性值</strong></p><p>属性值有 7 种类型：</p><ul><li>empty : 空值</li><li>u32 : big-endian 32位整形，如：<code>current-speed = &lt;115200&gt;;</code></li><li>u64 : big-endian 64位整形，分为两个32位整形，如：<code>reg = &lt;0x00080000 0x00010000&gt;;</code></li><li>string : 字符串类型，如：<code>label = &quot;storage&quot;;</code></li><li>phandle : 节点引用，如：<code>i2c-0 = &amp;i2c0;</code></li><li>prop-encoded-array : 任意数量的列表，如：<code>gpios = &lt;&amp;gpiob 5 0&gt;;</code></li><li>stringlist : 字符串列表，如：</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树的使用"></a>设备树的使用<a class="hash-link" href="#设备树的使用" title="Direct link to heading">#</a></h2><p>通过以上章节的描述，我们对设备树有了基本的了解，如何在应用开发中使用设备树？以csk6002_9s_nano开发板为例，在blinky sample中，通过调用devicetree.hAPI接口获取GPIO设实例，从而完成GPIO的控制：</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="设备树api接口"></a>设备树API接口<a class="hash-link" href="#设备树api接口" title="Direct link to heading">#</a></h3><ul><li><strong>可以在<code>zephyr.dts</code>中看到<code>led0</code>的配置片段</strong></li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain">dts</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">v1</span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&lt;csk/csk6.dtsi&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&lt;dt-bindings/pwm/pwm.h&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(206, 145, 120)">&quot;csk6002_9s_nano_pinctrl.dtsi&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;csk6002 9s nano&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;csk,csk6002_9s_nano&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        aliases </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                led0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">board_led_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                sw0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">user_button_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                pwm</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">led0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">green_pwm_led</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                i2c</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">i2c0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                i2c</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">i2c1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        leds </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpio-leds&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                board_led_2</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> board_led_2 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        gpios </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">gpioa </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;User BOARD_LED_2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><ul><li><strong>在devicetree.h中找到相应的API</strong></li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">DT_NODE_HAS_STATUS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">node_id</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> status</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">    </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODE_HAS_STATUS_INTERNAL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">node_id</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> status</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">DT_ALIAS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">alias</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_CAT</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">DT_N_ALIAS_</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> alias</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><ul><li><strong>在devicetree_unfixed.h 宏定义片段</strong></li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/* Existence and alternate IDs: */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">DT_N_S_leds_S_board_led_2_EXISTS</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">DT_N_ALIAS_led0</span><span class="token macro property">            </span><span class="token macro property expression">DT_N_S_leds_S_board_led_2</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">DT_N_NODELABEL_board_led_2</span><span class="token macro property"> </span><span class="token macro property expression">DT_N_S_leds_S_board_led_2</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>以上是<code>devicetree.h</code>API接口和<code>zephyr.dts</code>的关联方式，我们在备驱动程序、应用程序、测试、内核等开发中只需要<code>include &lt;devicetree.h&gt;</code>就可以获取设备树的API接口。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="在应用开发中使用设备树api接口"></a>在应用开发中使用设备树API接口<a class="hash-link" href="#在应用开发中使用设备树api接口" title="Direct link to heading">#</a></h3><p>以blinky sample为例，通过两种方式获取设备树节点配置信息：</p><ul><li><strong>方式1：通过<code>DEVICE_DT_GET(node_id)</code>这个接口传入<code>gpioa</code>的设备树<code>node_id</code>来获取<code>gpioa</code>实例</strong></li></ul><p>代码实现如下：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">LED0_NODE_ID</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">gpioa</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    dev </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">DEVICE_DT_GET</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">LED0_NODE_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>那么如何获取<code>gpioa</code>的<code>node_id</code>？
我们可以通过<code>devicetree.h</code>提供的<code>DT_NODELABEL(label)</code>这个API接口找到<code>gpioa</code>设备树节点：</p><p><code>gpioa</code>的<code>label</code>可以在<code>zephyr.dts</code>中<code>gpioa</code>的设备树配置中找到：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">gpioa</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> gpio@</span><span class="token number" style="color:rgb(181, 206, 168)">45900000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;listenai,csk-gpio&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        reg </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0x45900000</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0x100000</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        interrupts </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0x11</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0x2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;GPIO_A&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gpio</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">controller</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">gpio</span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">-</span><span class="token macro property expression">cells </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token macro property expression"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0x2</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        status </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;okay&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        phandle </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0x6</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>拿到<code>gpioa</code>设备树节点后，可通GPIO控制接口指定需要操作的GPIO的PIN脚来实现对GPIO的控制：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">PIN</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">5</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">FLAGS</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ret </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">gpio_pin_configure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> GPIO_OUTPUT_ACTIVE </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> FLAGS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token comment" style="color:rgb(106, 153, 85)">//配置GPIOA_5</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">gpio_pin_set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token comment" style="color:rgb(106, 153, 85)">//拉高GPIOA_5</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>代码实现中使用到了<code>DEVICE_DT_GET</code>这个接口获取GPIO实例，通过<code>node_id</code>获取指向设备对象的指针，如果您对zephyr API接口不熟悉，可以zephyr官网<a href="https://docs.zephyrproject.org/latest/kernel/drivers/index.html#group__device__model_1ga9a65996ce21f43acb7db061e23b48ec7" target="_blank" rel="noopener noreferrer">zephyr API</a>中找到对应的描述和使用说明。
以上我们通过<code>DEVICE_DT_GET</code>获取了<code>gpioa</code>设备树节点，但此后还需要再指定<code>GPIOA_5</code>的PIN脚和FLAG才能完成GPIO的控制，是否可以一次获取<code>zephyr.dts</code>中<code>led0</code>所有的配置属性信息？答案是肯定，接下来我们来看方式2的实现。</p><ul><li><strong>方式2：通过DT_ALIAS()API找到<code>led0</code>设备树配置，并解析<code>led0</code>的属性信息：</strong>
在<code>zephyr.dts</code>中<code>led0</code>的配置信息如下：</li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">        aliases </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                led0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">board_led_2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                sw0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">user_button_0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                pwm</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">led0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">green_pwm_led</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                i2c</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">i2c0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                i2c</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">i2c1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        leds </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                compatible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpio-leds&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                board_led_2</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> board_led_2 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        gpios </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">gpioa </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        label </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;User BOARD_LED_2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>我们在blinky实现代码中可以通过以下方式获取<code>led0</code>的属性信息：</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">LED0_NODE</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_ALIAS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">led0</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property comment" style="color:rgb(106, 153, 85)">//通过alias标签获取led0 node_id</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//通过led0 node_id解析led0 lable下的属性信息</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">LED0</span><span class="token macro property">    </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_GPIO_LABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">LED0_NODE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> gpios</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property comment" style="color:rgb(106, 153, 85)">//通过led0 node_id获取gpioa设备树配置</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">PIN</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_GPIO_PIN</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">LED0_NODE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> gpios</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property comment" style="color:rgb(106, 153, 85)">//获取PIN值</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">FLAGS</span><span class="token macro property">   </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_GPIO_FLAGS</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">LED0_NODE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> gpios</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property comment" style="color:rgb(106, 153, 85)">//获取flag值</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">device</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    dev </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">device_get_binding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">LED0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token comment" style="color:rgb(106, 153, 85)">//获取LED0实例</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">gpio_pin_set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token comment" style="color:rgb(106, 153, 85)">//操作GPIO口</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>根据<code>devicetree.h</code>中API定义，我们可以找到以下对应关系：</p><ul><li><code>DT_ALIAS(led0)</code>展开以后是<code>DT_N_ALIAS_led0</code>，可以在<code>devicetree_unfixed.h</code>文件中找到：<code>#define DT_N_ALIAS_led0 DT_N_S_leds_S_board_led_2</code>；</li><li>而<code>devicetree_unfixed.h</code>所定义的<code>DT_N_S_leds_S_board_led_2</code>的配置则对应<code>zephyr.dts</code>中<code>led0 = &amp;board_led_2</code>的配置。</li></ul><p>以上就是设备树的描述和使用示例，通过本章节的学习，您是否掌握了设备树的基本使用方法？如果您对设备树还有疑问或者有更深刻的理解，可以通过工单的形式向我们反馈，期待您的参与。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/chips/600X/application/kconfig"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 项目配置</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/chips/600X/application/peripheral/overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">外设驱动的使用 »</div></a></div></nav><div class="gitalk-wrapper"><ul class="gitalk-option"><li class="like"><i class="icon like-icon"></i> <span id="like_num">有帮助  0</span></li><li class="unlike"><i class="icon unlike-icon"></i> <span id="unlike_num">没帮助 0</span></li><li>文档反馈</li></ul></div></div></div><div class="col col--3" style="padding-left:0px"><div class="tableOfContents_9Tj1 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link">概述</a></li><li><a href="#设备树编译流程" class="table-of-contents__link">设备树编译流程</a><ul><li><a href="#设备树编译整体流程描述" class="table-of-contents__link">设备树编译整体流程描述</a></li><li><a href="#设备树编译的输入输出文件" class="table-of-contents__link">设备树编译的输入输出文件</a></li><li><a href="#使用设备树需要了解的文件" class="table-of-contents__link">使用设备树需要了解的文件</a></li></ul></li><li><a href="#设备树的定义" class="table-of-contents__link">设备树的定义</a><ul><li><a href="#设备树文件结构" class="table-of-contents__link">设备树文件结构</a></li><li><a href="#dts-语法" class="table-of-contents__link">DTS 语法</a></li></ul></li><li><a href="#设备树的使用" class="table-of-contents__link">设备树的使用</a><ul><li><a href="#设备树api接口" class="table-of-contents__link">设备树API接口</a></li><li><a href="#在应用开发中使用设备树api接口" class="table-of-contents__link">在应用开发中使用设备树API接口</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 安徽聆思智能科技有限公司皖ICP备05001217号</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8ca08ee5.js"></script>
<script src="/assets/js/main.8a90d51c.js"></script>
<script>!function(e,n,s,t,d){e[s]=e[s]||function(){(e[s].a=e[s].a||[]).push(arguments)},(d=n.createElement("script")).async=!0,d.src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js",n.body.appendChild(d)}(window,document,"simplemde")</script></body>
</html>