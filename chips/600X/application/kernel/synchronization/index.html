<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.2">
<title data-react-helmet="true">线程间同步 | 聆思文档中心</title><meta data-react-helmet="true" property="og:url" content="https://github.com/LISTENAI/chips/600X/application/kernel/synchronization"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="线程间同步 | 聆思文档中心"><meta data-react-helmet="true" name="description" content="概述"><meta data-react-helmet="true" property="og:description" content="概述"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://github.com/LISTENAI/chips/600X/application/kernel/synchronization"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/chips/600X/application/kernel/synchronization" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://github.com/LISTENAI/chips/600X/application/kernel/synchronization" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b99cbd79.css">
<link rel="preload" href="/assets/js/runtime~main.a29fc1d2.js" as="script">
<link rel="preload" href="/assets/js/main.85613e2c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1knm">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" titleclassname="navbar__title" href="/"><img src="/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--light_1H0o navbar__logo"><img src="/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--dark_2hTa navbar__logo"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/chips/4002/Chip_information_4002">芯片</a><a class="navbar__item navbar__link" href="/tools/LStudio">工具</a><a class="navbar__item navbar__link" href="/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a><a class="navbar__item navbar__link" href="/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/faq/faq">FAQ</a><a class="navbar__item navbar__link" href="/school/school">视频课程</a><a class="navbar__item navbar__link" href="/workorder/workorder">工单</a><div class="react-toggle displayOnlyInLargeViewport_3VZa react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_ZCuN"><img src="/img/light.svg" alt="" class="themedImage_1WWj themedImage--light_1H0o"><img src="/img/unlight.svg" alt="" class="themedImage_1WWj themedImage--dark_2hTa"></span></div><div class="react-toggle-track-x"><span class="toggle_ZCuN"><img src="/img/undark.svg" alt="" class="themedImage_1WWj themedImage--light_1H0o"><img src="/img/dark.svg" alt="" class="themedImage_1WWj themedImage--dark_2hTa"></span></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_MM2z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" titleclassname="navbar__title" href="/"><img src="/img/logo_light.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--light_1H0o navbar__logo"><img src="/img/logo_dark.svg" alt="LSOpen Logo" class="themedImage_1WWj themedImage--dark_2hTa navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link mobile__navbar__link--active" href="/chips/4002/Chip_information_4002">芯片</a></li><li class="menu__list-item"><a class="menu__link" href="/tools/LStudio">工具</a></li><li class="menu__list-item"><a class="menu__link" href="/AIsolution/ESR/Quick_start/Scheme_introduction">AI语音应用方案</a></li><li class="menu__list-item"><a class="menu__link" href="/Industrysolution/Scanning_pen/Scheme_introduction">行业Turnkey解决方案</a></li><li class="menu__list-item"><a class="menu__link" href="/faq/faq">FAQ</a></li><li class="menu__list-item"><a class="menu__link" href="/school/school">视频课程</a></li><li class="menu__list-item"><a class="menu__link" href="/workorder/workorder">工单</a></li></ul></div></div></div></nav><nav class="navbar subnavbar--fixed-top sub-navbar"><div class="navbar__inner subnavbar__inner"><div class="navbar__items"><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/chips/4002/Chip_information_4002">CSK4002</a><a aria-current="page" class="subnavbar__item subnavbar__link subnavbar__link--active" dirname="/chips" href="/chips/600X/overview/chips">CSK600X</a><a class="subnavbar__item subnavbar__link" dirname="/chips" href="/chips/micropython/index">MicroPython</a></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_2GEL"><aside class="docSidebarContainer_2S6d"><div class="sidebar_3rk8"><nav class="menu menu--responsive thin-scrollbar menu_1wJ3 menuWithAnnouncementBar_39W0" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_24hZ" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">简介</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/overview/chips">芯片</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/overview/nanokit">NanoKit 开发套件</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/overview/system">系统与软件</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">快速上手</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/quick_start/start_env">安装开发工具</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/quick_start/start_project">开始新项目</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/quick_start/doc_issue">反馈</a></li></ul></li><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--first menu__link--sublist menu__link--active" type="first" href="#!">应用开发</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/overview">概述</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/structure">应用代码结构</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/kconfig">项目配置</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/chips/600X/application/device_tree">设备树</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="0">外设驱动</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/overview">外设驱动的使用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/gpio">GPIO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/pwm">PWM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/UART">UART</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/I2C">I2C</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/ADC">ADC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/RTC">RTC</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/watchdog">WatchDog</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/peripheral/samples/display_kscan">Display kscan</a></li></ul></li><li class="menu__list-item menu__list-item--current"><a class="menu__link menu__link--sublist menu__link--active" type="" href="#!" tabindex="0">内核</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/chips/600X/application/kernel/synchronization">线程间同步</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" type="" href="#!" tabindex="0">组件</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/logger">日志</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/usb_class">USB 模块</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/display">显示/触摸</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/application/modules/lvgl">LVGL</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--first menu__link--sublist" type="first" href="#!">工具</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/sdk_command">SDK 操作</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/env_command">编译环境</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/create_command">创建项目</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/application_project">应用级提货单</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/app_build_flash">编译，烧录</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/debug_command">调试</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/filesystem">文件系统相关</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/trouble_shooting">疑难解答</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/chips/600X/tool/release_note">版本更新日志</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/chips/600X/FAQ/index">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_3dT7"><div class="container padding-top--md padding-bottom--lg center-container"><div class="row"><div class="col docItemCol_3Jy6"><div class="docItemContainer_1Utn"><article><div class="markdown"><header><h1 class="h1Heading_2YTE">线程间同步</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="概述"></a>概述<a class="hash-link" href="#概述" title="Direct link to heading">#</a></h2><p>在zephyr系统中，多线程同时运行时会被调度器同时调度，从系统层面来看线程是并行运行，系统对并行运行的线程有先后执行的要求，多线程间需要资源共享或配合时就需要线程同步功能。嵌入式操作系统都会提供线程同步手段，Zephyr也不例外，Zephyr提供了信号量，互斥锁，轮询三种内核对象作为多线程同步的方式。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="信号量semaphores"></a>信号量(Semaphores)<a class="hash-link" href="#信号量semaphores" title="Direct link to heading">#</a></h2><p>信号量是用于控制多个线程对一组资源的访问，使用信号量在生产者(ISR/Thread)和消费者(thread)之间同步。
信号量有以下特性：</p><ul><li>Zephyr的信号量在初始化时可以指定初始化计数值和最大计数值，生产者give时计数值+1，但不会超过最大值，消费者take时计数值-1，直到为0。</li><li>每次信号量give都会引发调度。</li><li>如果多个线程都在等待信号量，新产生的信号量会被等待时间最长的最高优先级线程接收。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="常用api接口"></a>常用API接口<a class="hash-link" href="#常用api接口" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*初始化信号量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">K_SEM_DEFINE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> initial_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> count_limit </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*初始化信号量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_sem_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_sem</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> initial_count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> limit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*等待信号量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_sem_take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_sem</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_timeout_t</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*发送信号量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_sem_give</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_sem</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>更多<code>Semaphore API</code>接口 可以在zephyr官网<a href="https://docs.zephyrproject.org/latest/doxygen/html/group__semaphore__apis.html" target="_blank" rel="noopener noreferrer">Semaphore APIS</a>中找到。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="信号量的使用"></a>信号量的使用<a class="hash-link" href="#信号量的使用" title="Direct link to heading">#</a></h3><p>以下是一个信号量使用例程，该示例创建了一个动态信号量，初始化两个线程，其中一个线程发送信号量，另一个线程接收信号量并执行相应的操作。实现代码如下：
<strong>信号量初始化</strong>
一个信号量使用一个类型为 k_sem 的变量定义，有两种方式可以完成信号量的初始化：     </p><ul><li>方法1，使用宏：</li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">K_SEM_DEFINE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">my_sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><ul><li>方法2，使用函数 </li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_sem</span><span class="token plain"> my_sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">k_sem_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p><strong>发送信号量</strong><br>
在thread或者ISR中发送信号量。</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">productor_thread</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">arg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name" style="color:rgb(78, 201, 176)">uint8_t</span><span class="token plain"> count </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ciunt </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            count</span><span class="token operator" style="color:rgb(212, 212, 212)">++</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain">     </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">/* count 每计数 20 次，释放一次信号量 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">count </span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">20</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token function" style="color:rgb(220, 220, 170)">k_sem_give</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token function" style="color:rgb(220, 220, 170)">printk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;productor thread give semaphore&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p><strong>接收信号量</strong>
一般情况下接收信号量的thread是消费者。</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">consumer_thread</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name" style="color:rgb(78, 201, 176)">uint8_t</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">/* 等待信号量，获取到信号量，则执行 number 自加的操作 */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">k_sem_take</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_sem</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">K_MSEC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token function" style="color:rgb(220, 220, 170)">printk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Input data not available!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            number</span><span class="token operator" style="color:rgb(212, 212, 212)">++</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token function" style="color:rgb(220, 220, 170)">printk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;consumer thread number %d &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p><strong>运行结果</strong></p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">*** Booting Zephyr OS build  ***</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">productor thread give semaphore  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">consumer thread number 1 </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">productor thread give semaphore  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">consumer thread number 2 </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">productor thread give semaphore  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">consumer thread number 3  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">productor thread give semaphore  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">consumer thread number 4  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">productor thread give semaphore  </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">consumer thread number 5 </span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>以上是信号量的基本使用示例，csk6 sdk中也提供了一个信号量的使用sample，路径<code>samples--&gt;synchronization</code>，可使用<code>lisa zep create</code>命令完成sample创建。</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="互斥量mutex"></a>互斥量(Mutex)<a class="hash-link" href="#互斥量mutex" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="概述-1"></a>概述<a class="hash-link" href="#概述-1" title="Direct link to heading">#</a></h3><p>互斥量是表现互斥现象的数据结构，本质上是一把锁，提供对资源的独占访问，通常作为保护多线程的临界区，当线程需要访问临界区时，调用<code>k_mutex_lock</code>，如果当前互斥量是解锁状态，则调用成功，调用线程可自由进入临界区，如果互斥量已经枷锁，调用线程会被阻塞，知道临界区中所有的线程完成并调用<code>k_mutex_unlock</code>。</p><p>互斥量有以下特性：</p><ul><li>Mutex只能用于线程之间，不能用于ISR中。</li><li>Mutex unlock时会引发调度。</li><li>低优先级线程获取锁后有高优先级线程等锁时会引起优先级倒置。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="常用api接口-1"></a>常用API接口<a class="hash-link" href="#常用api接口-1" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*初始化互斥量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">K_MUTEX_DEFINE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">name</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression">    </span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*初始化互斥量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_mutex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">    </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*加锁互斥量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_lock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_mutex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_timeout_t</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*解锁互斥量*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_unlock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_mutex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>更多<code>Mutex API</code>接口 可以在zephyr官网<a href="https://docs.zephyrproject.org/latest/doxygen/html/group__mutex__apis.html" target="_blank" rel="noopener noreferrer">Mutex APIs</a>中找到。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="互斥量的使用"></a>互斥量的使用<a class="hash-link" href="#互斥量的使用" title="Direct link to heading">#</a></h3><p>以下是互斥量使用例程，两个线程都要访问同一个IO资源，但IO同时只能被独占访问，因此需要使用互斥量来实现，实现代码如下：
<strong>互斥量初始化</strong>
一个互斥量使用一个类型为 k_mutex 的变量定义，有两种方式可以完成信号量的初始化：     </p><ul><li>方法1，使用宏：</li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">K_MUTEX_DEFINE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><ul><li>方法2，使用函数 </li></ul><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_mutex</span><span class="token plain"> my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p><strong>加锁和解锁信号量</strong>       </p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">LED0_NODE_ID</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">DT_NODELABEL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">gpioa</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">PIN</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">5</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">FLAGS</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">A_STACK_SIZE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">B_STACK_SIZE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">4096</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">K_THREAD_STACK_DEFINE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">thread_a_area</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> A_STACK_SIZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">K_THREAD_STACK_DEFINE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">thread_b_area</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> B_STACK_SIZE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_thread</span><span class="token plain"> thread_a_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_thread</span><span class="token plain"> thread_b_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    dev </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">DEVICE_DT_GET</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">LED0_NODE_ID</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ret </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">gpio_pin_configure</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> GPIO_OUTPUT_ACTIVE </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> FLAGS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_mutex</span><span class="token plain"> my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* create thread_a and thread_b */</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> pri </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_thread_priority_get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">k_current_get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_thread_create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">thread_a_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> thread_a_area</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token function" style="color:rgb(220, 220, 170)">K_THREAD_STACK_SIZEOF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">thread_a_area</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    thread_a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> pri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> K_NO_WAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_thread_create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">thread_b_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> thread_b_area</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token function" style="color:rgb(220, 220, 170)">K_THREAD_STACK_SIZEOF</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">thread_b_area</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    thread_b</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> pri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> K_NO_WAIT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*线程A操作IO时对互斥量的操作*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">thread_a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_lock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> K_FOREVER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/*操作GPIO*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">gpio_pin_set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_unlock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*线程B操作IO时对互斥量的操作*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">thread_b</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_lock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> K_FOREVER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/*操作GPIO*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">gpio_pin_set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> PIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_mutex_unlock</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">my_mutex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="轮询poll"></a>轮询(poll)<a class="hash-link" href="#轮询poll" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="概述-2"></a>概述<a class="hash-link" href="#概述-2" title="Direct link to heading">#</a></h3><p>Async poll是一个比较特殊的内核对象，polling API允许一个线程等待一个或者多个条件满足。支持的条件类型只能是内核对象，可以是Semaphore, FIFO, poll signal三种。
例如一个线程使用polling API同时等待多个semaphore，只要其中一个semaphore触发时polling API就会得到通知。
poll具有以下特性：</p><ul><li>当一个线程等待多个触发条件时，只要有一个条件满足k_poll就会返回。</li><li>当semaphore或FIFO满足条件后, k_poll只是接到通知返回，线程并未获取到semaphore或FIFO, 还需要使用代码主动获取。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="常用api接口-2"></a>常用API接口<a class="hash-link" href="#常用api接口-2" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*初始化一个k_poll_event实例*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll_event_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_poll_event</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token class-name" style="color:rgb(78, 201, 176)">uint32_t</span><span class="token plain"> type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> obj </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*轮询k_poll_event实例,等待触发条件*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_poll_event</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> num_events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_timeout_t</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">   </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*初始化poll signal信号，作为poll event的触发*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll_signal_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_poll_signal</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*发送poll signal信号*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll_signal_raise</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_poll_signal</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*清除signal信号，如果signal被发送，但还未被poll前，都可以使用该API reset清除*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll_signal_reset</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_poll_signal</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">/*获取signal信号的状态和值*/</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll_signal_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">k_poll_signal</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> sig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> signaled</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>更多<code>Poll API</code>接口 可以在zephyr官网<a href="https://docs.zephyrproject.org/latest/doxygen/html/group__poll__apis.html" target="_blank" rel="noopener noreferrer">Async polling APIs</a>中找到。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_1rmC" id="poll的使用"></a>Poll的使用<a class="hash-link" href="#poll的使用" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO"><pre tabindex="0" class="prism-code language-undefined codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token plain">**线程A poll信号是否发送**    </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">```c</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/*定义一个poll signal信号*/</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">struct k_poll_signal signal;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">void thread_A(void){</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*初始化信号，并将其作为poll条件*/</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    k_poll_signal_init(&amp;signal);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*初始化poll event条件*/</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    struct k_poll_event events[1] = {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        K_POLL_EVENT_INITIALIZER(K_POLL_TYPE_SIGNAL,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                 K_POLL_MODE_NOTIFY_ONLY,</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                 &amp;signal),</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    };</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    while(1){</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            k_poll(events, 1, K_FOREVER);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            if (events[0].signal-&gt;result == 0x1337) {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                printk(&quot;get signal&quot;);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                 printk(&quot;weird error&quot;);</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            /*在循环中调用 k_poll() 时，用户必须将event的state态重置为K_POLL_STATE_NOT_READY*/</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            events[0].signal-&gt;signaled = 0;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            events[0].state = K_POLL_STATE_NOT_READY;</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div><p>// 线程 B 发送signal信号触发event</p><div class="codeBlockContainer_3oNM"><div class="codeBlockContent_3GwO c"><pre tabindex="0" class="prism-code language-c codeBlock_11GL thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><div class="codeBlockLines_t3ov"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">thread_B</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">k_poll_signal_raise</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">signal</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0x1337</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span></span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3j15 clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/chips/600X/application/peripheral/samples/display_kscan"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Display kscan</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/chips/600X/application/modules/logger"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">日志 »</div></a></div></nav><div class="gitalk-wrapper"><ul class="gitalk-option"><li class="like"><i class="icon like-icon"></i> <span id="like_num">有帮助  0</span></li><li class="unlike"><i class="icon unlike-icon"></i> <span id="unlike_num">没帮助 0</span></li><li>文档反馈</li></ul></div></div></div><div class="col col--3" style="padding-left:0px"><div class="tableOfContents_9Tj1 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link">概述</a></li><li><a href="#信号量semaphores" class="table-of-contents__link">信号量(Semaphores)</a><ul><li><a href="#常用api接口" class="table-of-contents__link">常用API接口</a></li><li><a href="#信号量的使用" class="table-of-contents__link">信号量的使用</a></li></ul></li><li><a href="#互斥量mutex" class="table-of-contents__link">互斥量(Mutex)</a><ul><li><a href="#概述-1" class="table-of-contents__link">概述</a></li><li><a href="#常用api接口-1" class="table-of-contents__link">常用API接口</a></li><li><a href="#互斥量的使用" class="table-of-contents__link">互斥量的使用</a></li></ul></li><li><a href="#轮询poll" class="table-of-contents__link">轮询(poll)</a><ul><li><a href="#概述-2" class="table-of-contents__link">概述</a></li><li><a href="#常用api接口-2" class="table-of-contents__link">常用API接口</a></li><li><a href="#poll的使用" class="table-of-contents__link">Poll的使用</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 安徽聆思智能科技有限公司皖ICP备05001217号</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a29fc1d2.js"></script>
<script src="/assets/js/main.85613e2c.js"></script>
<script>!function(e,n,s,t,d){e[s]=e[s]||function(){(e[s].a=e[s].a||[]).push(arguments)},(d=n.createElement("script")).async=!0,d.src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js",n.body.appendChild(d)}(window,document,"simplemde")</script></body>
</html>